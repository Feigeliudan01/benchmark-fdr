---
title: "Manuscript Figures for Genome Biology"
author: "Rafalab"
output: 
    html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This Rmd generates the main manuscript figures. Additional Rmds
generate the supplementary case study and in silico experiment figures 
(`manuscript_figures.Rmd`) and supplementary case study figures 
(`manuscript_figures_sims.Rmd`). 

# Set up workspace 

```{r Figure2-load-data}
# Load packages and source benchmark FDR
library(tidyr)
library(dplyr)
library(ggplot2)
library(magrittr)
library(cowplot)
library(tibble)
library(ggthemes)
library(grid)
library(SummarizedBenchmark)

## load helper functions
for (f in list.files("../datasets/R", "\\.(r|R)$", full.names = TRUE)) {
    source(f)
}

# Assumes sb objects for the case studies and in silico experiments are in 
# the following location, which contains subfolders
# for each casestudy (if this isn't true, then parsing the case study and 
# dataset names later on will be incorrect)
path <- "../results"

# Also assumes that simulation results summary file is in the following location
# The `result-metrics.rds` was generated in the 
# `datasets/simulations/simulations-summary.Rmd` file.
resmet_file <- file.path("..", "datasets", "simulations", "results-summary", "result-metrics.rds")

# set up results directory
outdir <- "./figures"
dir.create(outdir, showWarnings = FALSE)

# set alpha cutoff for plots that are fixed at a certain value of alpha
alpha.thresh <- 0.05

# methods to include in all figures ( exclude bonferroni and fdrreg-e)
methodset <- c("bh", "ihw", paste0("ihw-a0", 1:9), "ihw-a10", 
               "qvalue", "bl", "bl-df03", "lfdr",
               "fdrreg-t", "ashq", "adapt-glm")
```


We use the standardize candy color scheme and line types for the plots.

```{r}
col <- as.character(candycols$col)
names(col) <- as.character(candycols$Method)
lty <- as.character(candycols$lty)
names(lty) <- as.character(candycols$Method)
```

To generate the figures in this document, the simulation results must first be aggregated by running the code at `datasets/simulations/simulations-summary.Rmd`.

```{r load-sim-metrics}
resmet <- readRDS(resmet_file)
```

Unfortunately, because the plots in this section illustrate FDR and TPR acorss varying simulation settings rather than varying nominal FDR cutoff, we cannot simply use the `plotsim_average()` function to generate plots. Instead, we define the following helper function to consistently generate plots similar to those output by `plotsim_average()` with arbitrary covariate, e.g. number of tests or proportion of null hypotheses, as the x-axis. The function assumes that the input table only includes FDR or TPR values for each method at a single nominal alpha cutoff. In these figures, we only plot FDR and TPR values at the nominal alpha cutoff of 0.05.

```{r genplot-function}
genplot <- function(tab, cov, type = c("info", "diff"), xt = "", met = c("FDR", "TPR"), ebw = 0.0025) {
    met <- match.arg(met)
    cov <- rlang::enquo(cov)
    type <- match.arg(type)
    if (type == "info") {
        ymean <- rlang::quo(mean.info)
        yse <- rlang::quo(se.info)
    } else if (type == "diff") {
        ymean <- rlang::quo(mean.diff)
        yse <- rlang::quo(se.diff)
    }        
    gp <- dplyr::filter(tab, key == met) %>%
        ggplot(aes(x = !!cov, y = !!ymean, color = Method, group = Method)) +
        geom_line(aes(linetype = Method), alpha = 0.85) +
        geom_errorbar(aes(ymin = !!ymean - !!yse, ymax = !!ymean + !!yse), width = ebw, alpha=0.5) +
        scale_linetype_manual(values = lty) + 
        scale_color_manual(values = col) +
        expand_limits(y = 0) +
        theme_classic() +
        theme(axis.title = element_text(face = "bold", size = 10),
              plot.title = element_text(face = "bold", size = 12))
    if (type == "diff") {
        gp <- gp + geom_hline(yintercept = 0, lty = 2, color = "blue", alpha = 1/2)
        gp <- gp + scale_y_continuous(bquote(Delta ~ .(met) ~ (informative-uninformative)),
                                      labels = scales::percent)
    } else {
        gp <- gp + scale_y_continuous(met, labels = scales::percent)
        if (met == "FDR") {
            if (rlang::quo_name(cov) == "alpha") {
                gp <- gp + geom_abline(lty = 2, color = "blue", alpha = 1/2) 
            } else {
                gp <- gp + geom_hline(yintercept = 0.05, lty = 2, color = "blue", alpha = 1/2) 
            }
        }
    }
    gp
}
```


# Figure 1 - FDR

This figure contains the main FDR results for the simulations and *in silico* 
experiments. Panel (A) contains the FDR results for a representative setting of
the yeast *in silico* experiments, showing that all methods control FDR. 
Panels (B) and (C) contain the FDR results for simulations that vary the number
of hypotheses and the proportion of null hypotheses, respectively. These results
show that some methods fail to control FDR under certain settings. We restrict
this plot to have the same y-axes.

Instead of three separate panels showing disjoint experiments/settings, this result
may be better shown by making a heat map with one column per experiment/setting, 
and one row per method, where the color shading indicates whether FDR is controlled
at the target level (for a fixed alpha level, say 0.05). The color scale could be 
divergent, such that points that lose FDR control are highlighted, and points that
are overly conservative are also identifiable. 

```{r Figure3, fig.width = 10, fig.height = 12}
## Figure 1A: FDR of methods in representative yeast setting at alpha.thresh
objects <- list.files( path, recursive=TRUE, pattern="rds", full.names=TRUE )
resfile <- objects[grepl("yeast-", objects) & 
                   grepl("de5", objects) & 
                  !grepl("uninf", objects)] 
de5 <- readRDS(file=resfile)
res5d <- plotsim_standardize(de5, alpha = seq(0.01, 0.10, 0.01)) %>% 
  filter(blabel %in% methodset)
p1a <- plotsim_average(res5d, met="FDR",
                merge_ihw = TRUE, errorBars=TRUE) +
      #ggtitle(expression(paste(bold("Yeast "), bolditalic("in silico"), bold(" experiment")))) +
      ggtitle("FDR control in yeast") +
      scale_x_continuous("alpha cutoff", breaks=seq(0, 1, by=0.02)) +
      expand_limits(y=0.12) +
      theme(plot.title = element_text(face = "bold", size = 12))

## Figure 1B: FDR of methods across varying number of tests at alpha.thresh
res_ntests <- dplyr::filter(resmet, setting == "varyingntests", 
                            alpha == alpha.thresh, Method %in% methodset)
p1b <- genplot(res_ntests, cov = ntests, met = "FDR", ebw = 0.05) +
    scale_x_continuous("Number of Tests", trans = "log10",
                       breaks = c(1e2, 5e2, 1e3, 5e3, 1e4, 5e4)) +
    guides(color = FALSE, linetype = FALSE) +
    ggtitle("Varying number of tests") +
    coord_cartesian(ylim = c(0,0.12))

## Figure 1C: FDR of methods across varying null proportion at alpha.thresh
res_pi0 <- dplyr::filter(resmet, setting == "varyingpi0", 
                         alpha == alpha.thresh, Method %in% methodset)
p1c <- genplot(res_pi0, cov = 100-pi0, met = "FDR", ebw = 2.5) +
    scale_x_continuous("Proportion of Non-Null Hypotheses",
                       breaks = 100 - c(5, seq(10, 90, by = 10), 95, 99)) + 
  guides(color = FALSE, linetype = FALSE) + 
  ggtitle("Varying non-null proportion") +
  expand_limits(y=0.12) 

## pull Figure 1 together
Fig1 <- plot_grid(p1a + theme(legend.position="none"), p1b, p1c, nrow = 1)
Fig1 <- plot_grid(Fig1, get_legend(p1a), rel_widths = c(1, .2))
Fig1
ggsave(file.path(outdir, "Fig1.pdf"), width=10, height=3)
```

# Figure 2 - Power

# Figure 3 - Robustness

# Figure 4 - Applicability

# Figure 5 - Summary

The summary of recommendations is created manually.

# Session information

```{r}
sessionInfo()
```
