---
title: "Simulation Figures for Genome Biology (simulations)"
author: "Rafalab"
output: 
    html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Figure2-load-data}
# Load packages and source benchmark FDR
library(tidyr)
library(dplyr)
library(ggplot2)
library(magrittr)
library(cowplot)
library(tibble)
library(ggthemes)
library(grid)
library(SummarizedBenchmark)

## load helper functions
for (f in list.files("../datasets/R", "\\.(r|R)$", full.names = TRUE)) {
    source(f)
}

# assumes sb objects are in the following location
path <- file.path("..", "datasets", "simulations", "results")

# set up results directory
outdir <- "./figures"
dir.create(outdir, showWarnings = FALSE)

methodset <- c("bonf", "bh", "ihw", "qvalue", "bl-df03", "lfdr",
               "scott-empirical", "scott-theoretical", "ashq")
```

# Data Preparation

First, we load summaries for all simulations results at significance thresholds
between 0.01 and 0.10. This process can take a long time (approximately 40 minutes
per alpha cutoff) because of the large number of simulation settings that must be
read in and summarized. Ideally, this initial step should be run externally separate
from this Rmd (by default, the following code chunk will not be run).

```{r, eval = FALSE}
for (ia in 1:10) {
    summary_file <- paste0("allres_alpha", 100*alpha, ".rds")
    if (!file.exists(summary_file)) {
        res_files <- list.files(path, "\\.rds$", full.names = TRUE)
        res <- lapply(res_files, function(x) {
            zz <- readRDS(x)
            zz <- plotsim_standardize(zz, alpha = alpha)
            zz <- dplyr::select(zz, rep, blabel, key, alpha, value)
            zz <- dplyr::group_by(zz, blabel, key, alpha)
            zz <- dplyr::summarize(zz,
                                   se = sd(value, na.rm = TRUE) / sqrt(sum(!is.na(value))),
                                   q10 = quantile(value, .1, na.rm = TRUE),
                                   q90 = quantile(value, .9, na.rm = TRUE),
                                   med_value = median(value, na.rm = TRUE),
                                   mean_value = mean(value, na.rm = TRUE),
                                   nNA = sum(is.na(value)))
            dplyr::ungroup(zz)
        })
        names(res) <- gsub("\\.rds$", "", basename(res_files))
        saveRDS(res, summary_file)
    }
}
```

Assuming that the summaries have been saved for all simulation settings at
the various FDR thresholds using the code above, we load the summarized results
and merge them into a single results table.

```{r}
res <- vector("list", 10)
for (ia in 1:10) {
    imethodset <- methodset
    imethodset[which(imethodset == "ihw")] <- paste0("ihw-a", sprintf("%02d", ia))
    ires <- readRDS(paste0("allres_alpha", ia, ".rds"))
    ires <- bind_rows(ires, .id = "setting")
    ires <- dplyr::mutate(ires, dist = gsub(".*?-benchmark-(.*)", "\\1", setting),
                         setting = gsub("(.*?)-benchmark-.*", "\\1", setting))
    ires <- dplyr::filter(ires, blabel %in% imethodset)
    ires <- dplyr::mutate(ires, blabel = gsub("(-a)(.*)", "", blabel))
    res[[ia]] <- ires
}
res <- bind_rows(res)
res <- dplyr::rename(res, Method = blabel)
res <- dplyr::mutate(res, Method = gsub("-df03", "", Method))
res <- dplyr::mutate(res, Method = factor(Method, levels = gsub("-df03", "", methodset)))
```

We clean up the annotations in the table for some of the more complex simulation settings.

```{r}
res <- dplyr::mutate(res, inform = ifelse(grepl("varyinginfo", setting), dist, NA))
res <- dplyr::mutate(res, inform = as.numeric(gsub("level", "", inform)))
res <- dplyr::mutate(res, dist = ifelse(grepl("varyinginfo", setting), "gaussian", dist))

res <- dplyr::mutate(res, pi0 = ifelse(grepl("varyingpi0", setting), dist, 90))
res <- dplyr::mutate(res, pi0 = as.numeric(gsub("nullprop", "", pi0)))
res <- dplyr::mutate(res, dist = ifelse(grepl("varyingpi0", setting), "gaussian", dist))

res <- dplyr::mutate(res, signal = ifelse(grepl("varyinges", setting), dist, NA))
res <- dplyr::mutate(res, dist = ifelse(grepl("^varyinges$", setting), "gaussian", dist))
res <- dplyr::mutate(res, dist = ifelse(grepl("^varyinges-t$", setting), "t11", dist))
res <- dplyr::mutate(res, dist = ifelse(grepl("^varyinges-chisq$", setting), "chisq4", dist))
res <- dplyr::mutate(res, setting = ifelse(grepl("varyinges", setting), "varyinges", setting))
```

We also replace the sampling noise labels with more plotting-friendly labels.

```{r}
res <- dplyr::mutate(res, dist = factor(dist, levels = c("gaussian", "t11", "t5", "chisq4"),
                                        labels = c(expression("Noise: " * N(0, 1)),
                                                   expression("Noise: " * t[11]),
                                                   expression("Noise: " * t[5]),
                                                   expression("Noise: " * {chi^2}[4]))))
```

We use the standardize candy color scheme and line types for the plots.

```{r}
col <- as.character(candycols$col)
names(col) <- as.character(candycols$Method)
lty <- as.character(candycols$lty)
names(lty) <- as.character(candycols$Method)
```

There are several different simulation settings that can be investigated.

```{r}
dplyr::distinct(res, setting)
```

Namely, simulation settings were run with to investigate the impact of different
informative covariates, noninformative covariates, varying null proportions,
varying covariate informativeness, and varying effect size distributions (including
unimodal effects as described in the ASH manuscript). Many of these simulation
settings were also run with different sampling noise distributions, including
Normal/Gaussian, t with 11 degrees of freedom, t with 5 degrees of freedom, and
Chi-squared with 4 degrees of freedom.


# Null Simulations

We subset on simulation results that look at informative and non-informative covariates across
different noise distributions.

For null simulations, rather than the false discovery rate, we take a look at the true negative
rate (equivalently, the proportion of false positives) since the FDR will be 1 if any rejections
are made. Additionally, we take a look at the FWER (the proportion of simulation replicates out
of 100 with at least one rejection). In these plots, `ashq`, `scott-theoretical` and `scott-theoretical`
are excluded for the Chi-Squared simulation settings.

```{r, fig.width = 18, fig.height = 8}
res_nullset <- dplyr::filter(res, setting == "null",
                             !(Method == "ashq" & grepl("chi\\^2", dist)),
                             !(grepl("scott", Method) & grepl("chi\\^2", dist)))
res_nullset <- tidyr::complete(res_nullset, setting, Method, dist, key)

null_tnr <- dplyr::filter(res_nullset, key == "TNR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    facet_grid(. ~ dist, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("TNR", labels = scales::percent) +
    ggtitle("Mean TNR Over 100 Replications") +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

null_fwer <- dplyr::filter(res_nullset, key == "FWER") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    facet_grid(. ~ dist, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("FWER", labels = scales::percent) +
    ggtitle("FWER Over 100 Replications") +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(null_tnr + guides(color = FALSE, linetype = FALSE),
                null_fwer + guides(color = FALSE, linetype = FALSE) + coord_cartesian(ylim = c(0, .2)),
                labels = LETTERS[1:2], ncol = 1)
gp <- plot_grid(gp, get_legend(null_tnr), rel_widths = c(1, 1/16))
gp
```


# Sampling Distributions

We just take a look at different noise distributions for a single informative covariate.

```{r, fig.width = 18, fig.height = 8}
res_noise <- dplyr::filter(res, setting == "informative-cubic")
res_noise <- tidyr::complete(res_noise, setting, Method, dist, key)

noise_fdr <- dplyr::filter(res_noise, key == "FDR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    geom_abline(intercept = 0, slope = 1, lty = 2, color = "blue", alpha = 1/2) + 
    facet_grid(. ~ dist, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("FDP", labels = scales::percent) +
    ggtitle("Mean FDP Over 100 Replications") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

noise_tpr <- dplyr::filter(res_noise, key == "TPR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    facet_grid(. ~ dist, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("TPR", labels = scales::percent) +
    ggtitle("Mean TPR Over 100 Replications") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(noise_fdr + guides(color = FALSE, linetype = FALSE) + coord_cartesian(ylim = c(0, .2)),
                noise_tpr + guides(color = FALSE, linetype = FALSE),
                labels = LETTERS[1:2], ncol = 1)
gp <- plot_grid(gp, get_legend(noise_tpr), rel_widths = c(1, 1/16))
gp
```


# Informative Covariates

We also take a look across different informative covariates.

```{r, fig.width = 18, fig.height = 8}
res_icov <- dplyr::filter(res, grepl("^informative", setting), grepl("N\\(0, 1\\)", dist))
res_icov <- tidyr::complete(res_icov, setting, Method, dist, key)

icov_fdr <- dplyr::filter(res_icov, key == "FDR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    geom_abline(intercept = 0, slope = 1, lty = 2, color = "blue", alpha = 1/2) + 
    facet_grid(. ~ setting, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("FDP", labels = scales::percent) +
    ggtitle("Mean FDP Over 100 Replications") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))
    
icov_tpr <- dplyr::filter(res_icov, key == "TPR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    facet_grid(. ~ setting, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("TPR", labels = scales::percent) +
    ggtitle("Mean TPR Over 100 Replications") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(icov_fdr + guides(color = FALSE, linetype = FALSE) + coord_cartesian(ylim = c(0, .2)),
                icov_tpr + guides(color = FALSE, linetype = FALSE),
                labels = LETTERS[1:2], ncol = 1)
gp <- plot_grid(gp, get_legend(icov_tpr), rel_widths = c(1, 1/16))
gp
```

The general trends are identical across informative covariates considered (cubic: a monotonic relationship,
sine: a non-monotone relationship, and step: a discrete relationship).


# Noninformative Covariates

We take a look at noninformative covariates on their own.

```{r, fig.width = 18, fig.height = 8}
res_noni <- dplyr::filter(res, grepl("noninformative", setting))
res_noni <- tidyr::complete(res_noni, setting, Method, dist, key)

noni_fdr <- dplyr::filter(res_noni, key == "FDR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    geom_abline(intercept = 0, slope = 1, lty = 2, color = "blue", alpha = 1/2) + 
    facet_grid(. ~ dist, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("FDP", labels = scales::percent) +
    ggtitle("Mean FDP Over 100 Replications (noninformative covariates)") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))
    
noni_tpr <- dplyr::filter(res_noni, key == "TPR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    facet_grid(. ~ dist, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("TPR", labels = scales::percent) +
    ggtitle("Mean TPR Over 100 Replications (noninformative covariates)") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(noni_fdr + guides(color = FALSE, linetype = FALSE) + coord_cartesian(ylim = c(0, .2)),
                noni_tpr + guides(color = FALSE, linetype = FALSE),
                labels = LETTERS[1:2], ncol = 1)
gp <- plot_grid(gp, get_legend(noni_tpr), rel_widths = c(1, 1/16))
gp
```

We next take a look at noninformative covariates against informative covariates.


# Noninformative vs. Informative

```{r, fig.width = 10, fig.height = 4}
res_compc <- dplyr::filter(res, grepl("informative-cubic", setting) |
                                grepl("noninformative", setting),
                           grepl("N\\(0, 1\\)", dist))
res_compc <- tidyr::complete(res_compc, setting, Method, dist, key)
res_compc <- dplyr::mutate(res_compc, lab = round(100*alpha))
res_compc <- dplyr::mutate(res_compc, lab = ifelse(lab %in% c(1, 10), lab, NA))

compc_fdr <- dplyr::filter(res_compc, key == "FDR") %>%
    dplyr::select(setting, Method, dist, alpha, lab, mean_value) %>%
    tidyr::spread(setting, mean_value) %>%
    ggplot(aes(x = noninformative, y = `informative-cubic`, label = lab,
               color = Method, linetype = Method)) +
    geom_abline(intercept = 0, slope = 1, lty = 2, color = "blue", alpha = 1/2) + 
    geom_hline(yintercept = c(.01, .1), lty = 2, color = "blue", alpha = 1/2) + 
    geom_vline(xintercept = c(.01, .1), lty = 2, color = "blue", alpha = 1/2) + 
    geom_line(alpha = 0.85) +
    geom_text(size = 3) + 
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("noninformative (FDP)", breaks = seq(0, 1, .02), labels = scales::percent) + 
    scale_y_continuous("informative (FDP)", breaks = seq(0, 1, .02), labels = scales::percent) + 
    ggtitle("Mean FDP Over 100 Replications") +
    expand_limits(x = 0, y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

compc_tpr <- dplyr::filter(res_compc, key == "TPR") %>%
    dplyr::select(setting, Method, dist, alpha, lab, mean_value) %>%
    tidyr::spread(setting, mean_value) %>%
    ggplot(aes(x = noninformative, y = `informative-cubic`, label = lab,
               color = Method, linetype = Method)) +
    geom_abline(intercept = 0, slope = 1, lty = 2, color = "blue", alpha = 1/2) + 
    geom_line(alpha = 0.85) +
    geom_text(size = 3) + 
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("noninformative (TPR)", labels = scales::percent) + 
    scale_y_continuous("informative (TPR)", labels = scales::percent) + 
    ggtitle("Mean TPR Over 100 Replications") +
    expand_limits(x = 0, y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(compc_fdr + guides(color = FALSE, linetype = FALSE),
                compc_tpr + guides(color = FALSE, linetype = FALSE),
                labels = LETTERS[1:2], nrow = 1)
gp <- plot_grid(gp, get_legend(compc_tpr), rel_widths = c(1, 1/8))
gp
```

We can also plot the differences.

```{r, fig.width = 10, fig.height = 4}
compc2_fdr <- dplyr::filter(res_compc, key == "FDR") %>%
    dplyr::select(setting, Method, dist, alpha, lab, mean_value) %>%
    tidyr::spread(setting, mean_value) %>%
    dplyr::mutate(gain = `informative-cubic` - noninformative) %>%
    ggplot(aes(x = alpha, y = gain, color = Method, linetype = Method)) +
    geom_hline(yintercept = 0, lty = 2, color = "blue", alpha = 1/2) + 
    geom_line(alpha = 0.85) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) + 
    scale_y_continuous("change in FDP", breaks = seq(-1, 1, .001), labels = scales::percent) + 
    ggtitle("Mean Change in FDP Over 100 Replications") +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

compc2_tpr <- dplyr::filter(res_compc, key == "TPR") %>%
    dplyr::select(setting, Method, dist, alpha, lab, mean_value) %>%
    tidyr::spread(setting, mean_value) %>%
    dplyr::mutate(gain = `informative-cubic` - noninformative) %>%
    ggplot(aes(x = alpha, y = gain, color = Method, linetype = Method)) +
    geom_hline(yintercept = 0, lty = 2, color = "blue", alpha = 1/2) + 
    geom_line(alpha = 0.85) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) + 
    scale_y_continuous("change in TPR", labels = scales::percent) + 
    ggtitle("Mean Change in TPR Over 100 Replications") +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(compc2_fdr + guides(color = FALSE, linetype = FALSE),
                compc2_tpr + guides(color = FALSE, linetype = FALSE),
                labels = LETTERS[1:2], nrow = 1)
gp <- plot_grid(gp, get_legend(compc2_tpr), rel_widths = c(1, 1/8))
gp
```


# Null Proportions

We take a look at the impact of the proportion of null hypotheses.

```{r, fig.width = 10, fig.height = 8}
res_pi0 <- dplyr::filter(res, setting == "varyingpi0-lowsignal", alpha %in% c(0.05, 0.10))
res_pi0 <- tidyr::complete(res_pi0, setting, Method, alpha, pi0, key)

pi0_fdr <- dplyr::filter(res_pi0, key == "FDR") %>%
    ggplot(aes(x = pi0, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 2.5, alpha=0.5) +
    geom_hline(aes(yintercept = alpha), lty = 2, color = "blue", alpha = 1/2) + 
    facet_grid(. ~ alpha, scales = "free_x", labeller = label_both) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("pi0", breaks = seq(0, 100, 10)) +
    scale_y_continuous("FDP", labels = scales::percent) +
    ggtitle("Mean FDP Over 100 Replications") +
    expand_limits(x =0, y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

pi0_tpr <- dplyr::filter(res_pi0, key == "TPR") %>%
    ggplot(aes(x = pi0, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 2.5, alpha=0.5) +
    facet_grid(. ~ alpha, scales = "free_x", labeller = label_both) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("pi0", breaks = seq(0, 100, 10)) +
    scale_y_continuous("TPR", labels = scales::percent) +
    ggtitle("Mean TPR Over 100 Replications") +
    expand_limits(x =0, y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(pi0_fdr + guides(color = FALSE, linetype = FALSE) + coord_cartesian(ylim = c(0, .2)),
                pi0_tpr + guides(color = FALSE, linetype = FALSE),
                labels = LETTERS[1:2], ncol = 1)
gp <- plot_grid(gp, get_legend(pi0_tpr), rel_widths = c(1, 1/8))
gp
```


# Informativeness

We take a look at the impact of the informativeness of a covariate.

```{r, fig.width = 10, fig.height = 8}
res_info <- dplyr::filter(res, setting == "varyinginfo-lowsignal", alpha %in% c(0.05, 0.10))
res_info <- tidyr::complete(res_info, setting, Method, alpha, inform, key)

info_fdr <- dplyr::filter(res_info, key == "FDR") %>%
    ggplot(aes(x = inform, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 2.5, alpha=0.5) +
    geom_hline(aes(yintercept = alpha), lty = 2, color = "blue", alpha = 1/2) + 
    facet_grid(. ~ alpha, scales = "free_x", labeller = label_both) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("informativeness", breaks = seq(0, 100, 10)) +
    scale_y_continuous("FDP", labels = scales::percent) +
    ggtitle("Mean FDP Over 100 Replications") +
    expand_limits(x =0, y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

info_tpr <- dplyr::filter(res_info, key == "TPR") %>%
    ggplot(aes(x = inform, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 2.5, alpha=0.5) +
    facet_grid(. ~ alpha, scales = "free_x", labeller = label_both) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("informativeness", breaks = seq(0, 100, 10)) +
    scale_y_continuous("TPR", labels = scales::percent) +
    ggtitle("Mean TPR Over 100 Replications") +
    expand_limits(x =0, y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(info_fdr + guides(color = FALSE, linetype = FALSE),
                info_tpr + guides(color = FALSE, linetype = FALSE),
                labels = LETTERS[1:2], ncol = 1)
gp <- plot_grid(gp, get_legend(info_tpr), rel_widths = c(1, 1/8))
gp
```


# Unimodal Effects

```{r, fig.width = 18, fig.height = 12}
res_uni <- dplyr::filter(res, setting == "varyinges")
res_uni <- dplyr::mutate(res_uni, dist = droplevels(dist))
res_uni <- tidyr::complete(res_uni, Method, signal, dist, key)

dplyr::filter(res_uni, key == "FDR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    geom_abline(intercept = 0, slope = 1, lty = 2, color = "blue", alpha = 1/2) + 
    facet_grid(dist ~ signal, scales = "free_x", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("FDP", labels = scales::percent) +
    ggtitle("Mean FDP Over 100 Replications") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

dplyr::filter(res_uni, key == "TPR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    facet_grid(dist ~ signal, scales = "free", labeller = label_parsed) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("TPR", labels = scales::percent) +
    ggtitle("Mean TPR Over 100 Replications") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))
```

We replot this only looking at Normal sampling noise.

```{r, fig.width = 18, fig.height = 8}
res_uni <- dplyr::filter(res_uni, grepl("N\\(0, 1\\)", dist))

uni_fdr <- dplyr::filter(res_uni, key == "FDR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    geom_abline(intercept = 0, slope = 1, lty = 2, color = "blue", alpha = 1/2) + 
    facet_wrap(~ signal, scales = "free_x", label = label_both, nrow = 1) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("FDP", labels = scales::percent) +
    ggtitle("Mean FDP Over 100 Replications") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

uni_tpr <- dplyr::filter(res_uni, key == "TPR") %>%
    ggplot(aes(x = alpha, y = mean_value, color = Method)) +
    geom_line(aes(linetype = Method), alpha = 0.85) +
    geom_errorbar(aes(ymin = mean_value - se, ymax = mean_value + se), width = 0.0025, alpha=0.5) +
    facet_wrap(~ signal, scales = "free", label = label_both, nrow = 1) +
    scale_linetype_manual(values = lty) + 
    scale_color_manual(values = col) +
    scale_x_continuous("alpha", breaks = seq(0, 1, .01)) +
    scale_y_continuous("TPR", labels = scales::percent) +
    ggtitle("Mean TPR Over 100 Replications") +
    expand_limits(y = 0) +
    theme_classic() +
    theme(axis.title = element_text(face="bold", size = 10),
          plot.title = element_text(face="bold", size = 14))

gp <- plot_grid(uni_fdr + guides(color = FALSE, linetype = FALSE) + coord_cartesian(ylim = c(0, .2)),
                uni_tpr + guides(color = FALSE, linetype = FALSE),
                labels = LETTERS[1:2], ncol = 1)
gp <- plot_grid(gp, get_legend(uni_tpr), rel_widths = c(1, 1/16))
gp
```
