---
title: "Manuscript Figures for Genome Biology (simulation subset)"
author: "Rafalab"
output: 
    html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-workspace}
## Load packages and source benchmark FDR
library(tidyverse)
library(cowplot)
library(ggthemes)
library(grid)
library(SummarizedBenchmark)

## load helper functions
for (f in list.files(file.path("..", "datasets", "R"), "\\.(r|R)$", full.names = TRUE)) {
    source(f)
}

# assumes sb objects are in the following location
resmet_file <- file.path("..", "datasets", "simulations", "results-summary", "result-metrics.rds")

# set up results directory
outdir <- "./figures"
dir.create(outdir, showWarnings = FALSE)

methodset <- c("bonf", "bh", "ihw", "qvalue", "bl-df03", "lfdr",
               "fdrreg-e", "fdrreg-t", "ashq", "adapt-glm")
```

We use the standardize candy color scheme and line types for the plots.

```{r}
col <- c(as.character(candycols$col), "darkgoldenrod3")
names(col) <- c(as.character(candycols$Method), "adapt-withnull")
lty <- c(as.character(candycols$lty), "dashed")
names(lty) <- c(as.character(candycols$Method), "adapt-withnull")
```

To generate the figures in this document, the simulation results must first be aggregated by running the code at `datasets/simulations/simulations-summary.Rmd`.

```{r load-sim-metrics}
resmet <- readRDS(resmet_file)
```

Unfortunately, because the plots in this section illustrate FDR and TPR acorss varying simulation settings rather than varying nominal FDR cutoff, we cannot simply use the `plotsim_average()` function to generate plots. Instead, we define the following helper function to consistently generate plots similar to those output by `plotsim_average()` with arbitrary covariate, e.g. number of tests or proportion of null hypotheses, as the x-axis. The function assumes that the input table only includes FDR or TPR values for each method at a single nominal alpha cutoff. In these figures, we only plot FDR and TPR values at the nominal alpha cutoff of 0.05.

```{r genplot-function}
genplot <- function(tab, cov, type = c("info", "diff"), xt = "", met = c("FDR", "TPR"), ebw = 0.0025) {
    met <- match.arg(met)
    cov <- rlang::enquo(cov)
    type <- match.arg(type)
    if (type == "info") {
        ymean <- rlang::quo(mean.info)
        yse <- rlang::quo(se.info)
    } else if (type == "diff") {
        ymean <- rlang::quo(mean.diff)
        yse <- rlang::quo(se.diff)
    }        
    gp <- dplyr::filter(tab, key == met) %>%
        ggplot(aes(x = !!cov, y = !!ymean, color = Method, group = Method)) +
        geom_line(aes(linetype = Method), alpha = 0.85) +
        geom_errorbar(aes(ymin = !!ymean - !!yse, ymax = !!ymean + !!yse), width = ebw, alpha=0.5) +
        scale_linetype_manual(values = lty) + 
        scale_color_manual(values = col) +
        expand_limits(y = 0) +
        theme_classic() +
        theme(axis.title = element_text(face = "bold", size = 10),
              plot.title = element_text(face = "bold", size = 14))
    if (type == "diff") {
        gp <- gp + geom_hline(yintercept = 0, lty = 2, color = "blue", alpha = 1/2)
        gp <- gp + scale_y_continuous(bquote(atop(Mean ~ Delta ~ .(met), (informative-uninformative))),
                                      labels = scales::percent)
    } else {
        gp <- gp + scale_y_continuous(met, labels = scales::percent)
        if (met == "FDR") {
            if (rlang::quo_name(cov) == "alpha") {
                gp <- gp + geom_abline(lty = 2, color = "blue", alpha = 1/2) 
            } else {
                gp <- gp + geom_hline(yintercept = 0.05, lty = 2, color = "blue", alpha = 1/2) 
            }
        }
    }
    gp
}
```

# Figure 3

This is a faceted figure with results from the pure simulation studies showing several key results from a subset of simulation settings. Namely, the figure includes plots of FDR and TPR values at a nominal FDR cutoff of 0.05 over 100 replications illustrating the impact of (A,B) changing total number of tests, (C,D) changing the proportion of non-null tests, and (E,F) changing the informativeness of a covariate. 

```{r Figure3, fig.width = 10, fig.height = 12}
## Figure 3A,B: FDR/TPR of methods across varying informativeness at alpha = 0.05
res_info <- dplyr::filter(resmet, setting == "varyinginfo-smooth", alpha == 0.05)
p3a <- genplot(res_info, cov = inform, met = "FDR", ebw = 2.5) +
    scale_x_continuous("Informativeness", breaks = seq(0, 100, by = 20))
p3b <- genplot(res_info, cov = inform, met = "TPR", ebw = 2.5) +
    scale_x_continuous("Informativeness", breaks = seq(0, 100, by = 20))

## add title to 3A,B
p3ab <- plot_grid(p3a + guides(color = FALSE, linetype = FALSE),
                  p3b + guides(color = FALSE, linetype = FALSE),
                  labels = LETTERS[1:2], ncol = 2)
p3abTitle <- ggdraw() +
    draw_label("Simulation performance across varying informativeness",
               fontface = 'bold')
p3ab <- plot_grid(p3abTitle, p3ab, ncol = 1, rel_heights = c(0.1, 1))


## Figure 3C,D: FDR/TPR of methods across varying number of tests at alpha = 0.05
res_ntests <- dplyr::filter(resmet, setting == "varyingntests", alpha == 0.05)
p3c <- genplot(res_ntests, cov = ntests, met = "FDR", ebw = 0.05) +
    scale_x_continuous("Number of Tests", trans = "log10",
                       breaks = c(1e2, 5e2, 1e3, 5e3, 1e4, 5e4))
p3d <- genplot(res_ntests, cov = ntests, met = "TPR", ebw = 0.05) +
    scale_x_continuous("Number of Tests", trans = "log10",
                       breaks = c(1e2, 5e2, 1e3, 5e3, 1e4, 5e4))

## add title to 3C,D
p3cd <- plot_grid(p3c + guides(color = FALSE, linetype = FALSE),
                  p3d + guides(color = FALSE, linetype = FALSE),
                  labels = LETTERS[3:4], ncol = 2)
p3cdTitle <- ggdraw() +
    draw_label("Simulation performance across varying numbers of hypotheses",
               fontface = 'bold')
p3cd <- plot_grid(p3cdTitle, p3cd, ncol = 1, rel_heights = c(0.1, 1))


## Figure 3E,F: FDR/TPR of methods across varying null proportion at alpha = 0.05
res_pi0 <- dplyr::filter(resmet, setting == "varyingpi0", alpha == 0.05)
p3e <- genplot(res_pi0, cov = 100-pi0, met = "FDR", ebw = 2.5) +
    scale_x_continuous("Proportion of Non-Null Hypotheses",
                       breaks = 100 - c(5, seq(10, 90, by = 10), 95, 99))
p3f <- genplot(res_pi0, cov = 100-pi0, met = "TPR", ebw = 2.5) +
    scale_x_continuous("Proportion of Non-Null Hypotheses",
                       breaks = 100 - c(5, seq(10, 90, by = 10), 95, 99))

## add title to 3E,F
p3ef <- plot_grid(p3e + guides(color = FALSE, linetype = FALSE),
                  p3f + guides(color = FALSE, linetype = FALSE),
                  labels = LETTERS[5:6], ncol = 2)
p3efTitle <- ggdraw() +
    draw_label("Simulation performance across varying non-null proportion",
               fontface = 'bold')
p3ef <- plot_grid(p3efTitle, p3ef, ncol = 1, rel_heights = c(0.1, 1))


## pull Figure 3 together
Fig3 <- plot_grid(p3ab, p3cd, p3ef, ncol = 1)
Fig3 <- plot_grid(Fig3, get_legend(p3a), rel_widths = c(1, .2))
Fig3
ggsave(file.path(outdir, "Figure3.pdf"), width=10, height=12)
```

# Supplementary Figure (distributions)

This is a faceted figure with results from the pure simulation studies showing the behavior of methods across different test statistic distributions. Test statistics were simulated from Normal, t with 11 degrees of freedom, t with 5 degrees of freedom, and Chi-squared with 4 degrees of freedom. We plot TPR and FDR across 100 replicates over nominal FDR cutoffs of 0.01 to 0.10. Additionally, we plot the differences in TPR and FDR for methods when using an informative or an uninformative covariate.

```{r SFigureSim1, fig.width = 14, fig.height = 16}
## SFigure Sim1 A,B: FDR/TPR of methods across varying test statistics distribution
res_noise <- dplyr::filter(resmet, setting == "informative-cubic")
ps1a <- genplot(res_noise, cov = alpha, met = "FDR") +
    facet_grid(. ~ dist, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)
ps1b <- genplot(res_noise, cov = alpha, met = "TPR") +
    facet_grid(. ~ dist, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)

## SFigure Sim1 C,D: FDR/TPR difference of methods
ps1c <- genplot(res_noise, cov = alpha, type = "diff", met = "FDR") +
    facet_grid(. ~ dist, labeller = label_parsed) + 
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)
ps1d <- genplot(res_noise, cov = alpha, type = "diff", met = "TPR") +
    facet_grid(. ~ dist, labeller = label_parsed) + 
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0) +
    ylab(expression(paste("Mean ", Delta, "TPR (informative-uninformative)")))

## create title for SFigure Sim1
ps1Title <- ggdraw() +
    draw_label("Simulation performance across test statistic distributions",
               fontface = 'bold', size = 20)

## pull SFigure Sim1 together
SFigS1 <- plot_grid(ps1a + guides(color = FALSE, linetype = FALSE),
                    ps1b + guides(color = FALSE, linetype = FALSE),
                    ps1c + guides(color = FALSE, linetype = FALSE),
                    ps1d + guides(color = FALSE, linetype = FALSE),
                    labels = LETTERS[1:4], ncol = 1)
SFigS1 <- plot_grid(ps1Title, SFigS1, ncol = 1, rel_heights = c(0.03, 1))
SFigS1 <- plot_grid(SFigS1, get_legend(ps1a), rel_widths = c(7.5, 1))
SFigS1
ggsave(file.path(outdir, "SFigureSim1.pdf"), width=14, height=16)
```

# Supplementary Figure (unimodal assumption)

This is a faceted figure with results from the pure simulation studies showing the behavior of methods across different sampling distributions of the effect size for non-null tests. The distributions of effect sizes used here were taken from the Stephens (Biostatistics, 2016) paper which originally introduced the ASH method. All effect size distributions are unimodal, with the exception of the appropriately named "bimodal" setting. The effect size distributions from the ASH manuscript have been doubled from their original implementations since TPRs were low (<10%) for all methods at their original magnitude. Again, the FDR and TPR as well as FDR and TPR differences are plotted for all methods.

```{r SFigureSim2, fig.width = 10, fig.height = 14}
res_ua <- dplyr::filter(resmet, setting == "uasettings", grepl("N\\(0, 1\\)", dist),
                        signal != "bimodal")

## SFigure Sim2 A,B: FDR/TPR of methods across unimodal effect size distribution
ps2a <- genplot(res_ua, cov = alpha, met = "FDR") +
    facet_grid(. ~ signal, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)
ps2b <- genplot(res_ua, cov = alpha, met = "TPR") +
    facet_grid(. ~ signal, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)

## SFigure Sim2 C,D: FDR/TPR difference of methods
ps2c <- genplot(res_ua, cov = alpha, type = "diff", met = "FDR") +
    facet_grid(. ~ signal, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0) +
    ylab(expression(paste("Mean ", Delta, "FDR (informative-uninformative)")))
ps2d <- genplot(res_ua, cov = alpha, type = "diff", met = "TPR") +
    facet_grid(. ~ signal, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0) +
    ylab(expression(paste("Mean ", Delta, "TPR (informative-uninformative)")))

## create title for SFigure Sim2
ps2Title <- ggdraw() +
    draw_label("Simulation performance across unimodal effect size distributions",
               fontface = 'bold', size = 17)

## pull SFigure Sim2 together
SFigS2 <- plot_grid(ps2a + guides(color = FALSE, linetype = FALSE),
                    ps2b + guides(color = FALSE, linetype = FALSE),
                    ps2c + guides(color = FALSE, linetype = FALSE),
                    ps2d + guides(color = FALSE, linetype = FALSE),
                    labels = LETTERS[1:4], ncol = 1)
SFigS2 <- plot_grid(ps2Title, SFigS2, ncol = 1, rel_heights = c(0.03, 1))
SFigS2 <- plot_grid(SFigS2, get_legend(ps2a), rel_widths = c(6.5, 1))
SFigS2
ggsave(file.path(outdir, "SFigureSim2.pdf"), width=10, height=14)
```

# Supplementary Figure (covariate relationship)

This is a faceted figure with results from the pure simulation studies showing the behavior of methods across different function relationships between the informative covariate and null probability (pi0) of a test. In addition to the more deliberately designed sequence of informative covariates studied in the "informativeness" set of simulations described above, we also considered four functional relationships between the covariate and pi0, named "step", "sine", "cosine", and "cubic". Again, the FDR and TPR as well as FDR and TPR differences are plotted for all methods. The relationship between the covariate (sampled from the interval between 0 and 1) and pi0 is plotted for each setting as well.

```{r SFigureSim3, fig.width = 12, fig.height = 16}
res_icov <- dplyr::filter(resmet, grepl("^informative", setting), grepl("N\\(0, 1\\)", dist))
res_icov <- dplyr::mutate(res_icov, relationship = gsub("informative-", "", setting))

## SFigure Sim3 A: Form of informative covariate and pi0 relationship
pi0form <- tibble(x = seq(0, 1, .01))
pi0form <- dplyr::mutate(pi0form,
                         cosine = pi0_cosine(0.9)(x),
                         cubic = pi0_cubic(0.9)(x),
                         sine = pi0_sine(0.9)(x),
                         step = pi0_step(0.9)(x))
pi0form <- tidyr::gather(pi0form, relationship, pi0, -x)
ps3a <- ggplot(pi0form, aes(x = x, y = pi0)) +
    geom_line() +
    expand_limits(y = c(0.5, 1)) + 
    theme_classic() +
    scale_x_continuous(breaks = seq(0, 1, .2)) + 
    scale_y_continuous(labels = scales::percent) + 
    theme(axis.title = element_text(face = "bold", size = 10),
          plot.title = element_text(face = "bold", size = 14)) +
    facet_grid(. ~ relationship)

## SFigure Sim3 B,C: FDR/TPR of methods across varying relationships
ps3b <- genplot(res_icov, cov = alpha, met = "FDR") +
    facet_grid(. ~ relationship, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0) +
    ylab(expression(paste("Mean ", Delta, "FDR (informative-uninformative)")))
ps3c <- genplot(res_icov, cov = alpha, met = "TPR") +
    facet_grid(. ~ relationship, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0) +
    ylab(expression(paste("Mean ", Delta, "TPR (informative-uninformative)")))

## SFigure Sim3 D,E: FDR/TPR difference of methods
ps3d <- genplot(res_icov, cov = alpha, type = "diff", met = "FDR") +
    facet_grid(. ~ relationship, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)
ps3e <- genplot(res_icov, cov = alpha, type = "diff", met = "TPR") +
    facet_grid(. ~ relationship, labeller = label_parsed) +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)

## create title for SFigure Sim3
ps3Title <- ggdraw() +
    draw_label("Simulation performance across informative covariate relationship",
               fontface = 'bold', size = 20)

## pull SFigure Sim3 together
SFigS3 <- plot_grid(ps3a + guides(color = FALSE, linetype = FALSE),
                    ps3b + guides(color = FALSE, linetype = FALSE),
                    ps3c + guides(color = FALSE, linetype = FALSE),
                    ps3d + guides(color = FALSE, linetype = FALSE),
                    ps3e + guides(color = FALSE, linetype = FALSE),
                    labels = LETTERS[1:5], ncol = 1, rel_heights = c(.6, rep(1, 4)))
SFigS3 <- plot_grid(ps3Title, SFigS3, ncol = 1, rel_heights = c(0.03, 1))
SFigS3 <- plot_grid(SFigS3, get_legend(ps3b), rel_widths = c(6.5, 1))
SFigS3
ggsave(file.path(outdir, "SFigureSim3.pdf"), width=12, height=16)
```

# Supplementary Figure (AdaPT with null model)

This is a faceted figure with results from running the AdaPT method with non-default parameter settings. Based on communications with the authors of the methods, in addition to applying the method with parameter settings described in the accompanying package vignette, we attempted running the method with a non-default set of parameters. Namely, we run the method including a null relationship between the covariate and the null probability as one of the candidate "models", allowing the AdaPT method to ignore the specified covariate when it does not appear to be "informative enough". This model is denoted by `adapt-withnull`. The simulations were performed with the "step" informative covariate setting described above, under which the AdaPT method achieved lower TPR with the weakly informative covariate than with a completely uninformative covariate.

Since these results are not included in the primary set of simulation results summarized in the `resmet` object, we recompute them from the output of the `supplementary/simulations-informative-step-nullAdaPT.Rmd` simulation case study.

We only include a subset of methods in this plot because the primary focus is on the relative performance of AdaPT with default and modified parameters.

```{r SFigureS4-parse-data}
method_subset <- c("bonf", "bh", "qvalue", "adapt-glm", "adapt-withnull")

nullAdapt <- readRDS(file.path("..", "datasets", "simulations", "supplementary", "results",
                               "nullAdaPT-informative-step-benchmark-gaussian.rds"))

nullAdapt_i <- lapply(nullAdapt, `[[`, "informative")
nullAdapt_i <- plotsim_standardize(nullAdapt_i, alpha = seq(0.01, 0.10, 0.01))
nullAdapt_i <- dplyr::select(nullAdapt_i, rep, blabel, param.alpha, key, performanceMetric, alpha, value)

nullAdapt_u <- lapply(nullAdapt, `[[`, "uninformative")
nullAdapt_u <- plotsim_standardize(nullAdapt_u, alpha = seq(0.01, 0.10, 0.01))
nullAdapt_u <- dplyr::select(nullAdapt_u, rep, blabel, param.alpha, key, performanceMetric, alpha, value)

nullAdapt <- dplyr::full_join(nullAdapt_i, nullAdapt_u,
                              by = c("rep", "blabel", "param.alpha", "key", "performanceMetric", "alpha"),
                              suffix = c(".info", ".uninfo"))

nullAdapt <- dplyr::filter(nullAdapt, blabel %in% method_subset)

nullAdapt <- dplyr::select(nullAdapt, -param.alpha, -key)
nullAdapt <- dplyr::rename(nullAdapt, Method = blabel, key = performanceMetric)
nullAdapt <- dplyr::mutate(nullAdapt, Method = factor(Method, levels = method_subset))

adaptmet <- dplyr::mutate(nullAdapt,
                          value.info = ifelse(is.na(value.info) & grepl("R$", key), 0, value.info),
                          value.uninfo = ifelse(is.na(value.uninfo) & grepl("R$", key), 0, value.uninfo))

adaptmet <- dplyr::group_by(adaptmet, Method, key, alpha)
adaptmet <- dplyr::summarize(adaptmet,
                             mean.info = mean(value.info, na.rm = TRUE),
                             se.info = sd(value.info, na.rm = TRUE) / sqrt(sum(!is.na(value.info))),
                             nNA.info = sum(is.na(value.info)),
                             mean.diff = mean(value.info - value.uninfo, na.rm = TRUE),
                             se.diff = sd(value.info - value.uninfo, na.rm = TRUE) /
                                 sqrt(sum(!is.na(value.info - value.uninfo))))
adaptmet <- dplyr::ungroup(adaptmet)
```

After computing the performance metrics, we now plot the results for AdaPT with default and modified parameter settings. Again, we plot the mean FDR and TPR at nominal FDR cutoffs of 0.01 to 0.10 across 100 replications, as well as the FDR and TPR differences with and without the informative covariate.

```{r SFigureSim4, fig.width = 8, fig.height = 6}
## SFigure Sim4 A,B: FDR/TPR of methods including adapt with null
ps4a <- genplot(adaptmet, cov = alpha, met = "FDR") +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)
ps4b <- genplot(adaptmet, cov = alpha, met = "TPR") +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)

## SFigure Sim4 C,D: FDR/TPR difference of methods
ps4c <- genplot(adaptmet, cov = alpha, type = "diff", met = "FDR") +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)
ps4d <- genplot(adaptmet, cov = alpha, type = "diff", met = "TPR") +
    scale_x_continuous(breaks = seq(0, .1, .02)) +
    expand_limits(x = 0)

## create title for SFigure Sim4
ps4Title <- ggdraw() +
    draw_label("Simulation performance with modified AdaPT parameters",
               fontface = 'bold', size = 10)

## pull SFigure Sim4 together
SFigS4 <- plot_grid(ps4a + guides(color = FALSE, linetype = FALSE),
                    ps4b + guides(color = FALSE, linetype = FALSE),
                    ps4c + guides(color = FALSE, linetype = FALSE),
                    ps4d + guides(color = FALSE, linetype = FALSE),
                    labels = LETTERS[1:4], ncol = 2)
SFigS4 <- plot_grid(ps4Title, SFigS4, ncol = 1, rel_heights = c(0.06, 1))
SFigS4 <- plot_grid(SFigS4, get_legend(ps4b), rel_widths = c(4.5, 1))
SFigS4
ggsave(file.path(outdir, "SFigureSim4.pdf"), width=8, height=6)
```

# Session information

```{r}
sessionInfo()
```
