---
title: "Manuscript Figures for Genome Biology"
author: "Rafalab"
output: 
    html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Figure 1

This is a schema of Inputs, Assumptions and Outputs for the various FDR methods. Claire is leading this charge. 

# Figure 2

This is a faceted figure with results using the yeast data with 48 biological replicates analyzed in this [publication](https://www.ncbi.nlm.nih.gov/pubmed/26206307/). A complete analysis 
can be found in the `/datasets/RNA-Seq/yeast-simulation.Rmd`. This is the 5v5 comparison.  

```{r Figure2-load-data}
# Load packages and source benchmark FDR
library(tidyr)
library(dplyr)
library(ggplot2)
library(magrittr)
library(cowplot)
library(tibble)
library(ggthemes)
library(grid)
library(SummarizedBenchmark)

## load helper functions
for (f in list.files("../datasets/R", "\\.(r|R)$", full.names = TRUE)) {
    source(f)
}

# assumes sb objects are in the following location, which contains subfolders
# for each casestudy (if this isn't true, then parsing the case study and 
# dataset names later on will be incorrect)
path <- "../results"

# set up results directorie
outdir <- "./figures"
dir.create(outdir, showWarnings = FALSE)

# set alpha cutoff for plots that are fixed at a certain value of alpha
alpha <- 0.10
```


```{r Figure2}
objects <- list.files( path, recursive=TRUE, pattern="rds", full.names=TRUE )
resfile <- objects[grepl("yeast", objects) & grepl("de5", objects)] 
de5 <- readRDS(file=resfile)
excludeSet <- c("unadjusted", "bl-df02", "bl-df04", "bl-df05")
res5d <- plotsim_standardize(de5, alpha = seq(0.01, 0.10, 0.01))

# Figure 2A: Not all methods control FDR at nominal alpha level
p1 <- plotsim_average(res5d, met="FDR",filter_set = excludeSet,
                merge_ihw = TRUE, errorBars=TRUE) +
      theme(legend.position="none")

# Figure 2B: TPR of methods across nominal alpha level
p2 <- plotsim_average(res5d, met="TPR",filter_set = excludeSet,
                merge_ihw = TRUE, errorBars=TRUE) +
      theme(legend.position="none")

# Figure 2C: Total number of discoveries varied across method
p3 <- plotsim_average(res5d, met="rejections",filter_set = excludeSet,
                merge_ihw = TRUE, errorBars=TRUE) +
      theme(legend.position="none")

# Figure 2D: Some methods are tailored to detecting smaller effect sizes
p4 <- covariateLinePlot(de5, alpha=alpha, covname="log2FC", trans="log1p",
                        nbins=25)
leg <- get_legend(p4)
p4 <- p4 + theme(legend.position="none") + 
  ggtitle("Mean % significant by effect size %ile") + 
  theme(axis.title = element_text(face="bold", size = 10),
        plot.title = element_text(face="bold", size = 14)) +
  xlab("Effect size (log2 fold change) percentile")
  
# Figure 2E - upsetr plot - save separately
pdf(file.path(outdir, "Figure2E.pdf"), width = 10, height = 4, onefile=FALSE)
aggupset(de5, alpha=alpha, supplementary = FALSE, 
                       return_list = FALSE, nintersects = 12)
grid.text("Mean overlap Over 100 Replications", x = 0.6, y = 0.97, 
          gp = gpar(fontsize = 16, fontface = "bold"))
grid.text("E", x = 0.02, y = 0.97, 
          gp = gpar(fontsize = 24, fontface = "bold")) 
dev.off()

# Figure 2 (ALL)
Fig2 <- plot_grid(p1, p2, p3, p4, ncol = 2, 
          labels = LETTERS[1:4], label_size = 20)
Fig2 <- plot_grid(Fig2, leg, ncol = 2, rel_widths = c(1, 0.2))
Fig2
ggsave(file.path(outdir, "Figure2A-D.pdf"), width=10, height=8)

```

# Figure 3

This is a side-by-side figure displaying the TPR by alpha cutoff, faceted by 
whether the method uses multiple pieces of information or just one (the p-value).
This figure uses the same data as Figure 1.
  
```{r, Figure3}
# Figure 3: TPR of methods using by pieces of information used 
Fig3 <- plotsim_average(res5d, met="TPR", filter_set = excludeSet,
                merge_ihw = TRUE, errorBars=TRUE, facetMethodType = TRUE) 

Fig3
ggsave(file.path(outdir, "Figure3.pdf"), width=8, height=4)
```

# Figure 4 

This is a heatmap of methods by case studies with color representing the ranking
by of number of rejections @ FDR cutoff `r alpha`.

```{r, Figure 4}
library(SummarizedBenchmark)
library(stringr)

objects <- list.files( path, recursive=TRUE, pattern="rds", full.names=TRUE )

# remove simulation objects
sim <- unique(c(which(grepl("simulations", objects)),
               which(grepl("yeast", objects)),
               which(grepl("polyester", objects))))
if (length(sim) > 0){
  objects <- objects[-sim]
}

# remove microbiome objects from 'null' comparisons
# removing baxter, goodrich and papa OTU-level (since they mostly found 
# nothing for all methods and the genus-level analysis is also present)
null <- which(grepl(c("goodrich|papa"), objects) & 
              grepl(c("otu"), objects) | 
              grepl("baxter", objects))

if (length(null) > 0){
  objects <- objects[-null]
}

# remove chip-seq promoter analysis (since it is the only one that uses 
# ash and we also include the csaw analysis on the same dataset).
promot <- which(grepl("promot", objects))
if (length(promot) > 0){
  objects <- objects[-promot]
}

# grab casestudy names
obj.names <- str_split(objects, pattern = "/")
casestudy <- unlist(lapply(obj.names, function(x) x[3] ))
dataset <- unlist(lapply(obj.names, function(x) x[4] ))

Fig4.rowOrder <- levels(plotMethodRanks(objects, colLabels = casestudy, alpha = alpha,
                            tableOnly = TRUE)$method)
Fig4 <- plotMethodRanks(objects, colLabels = casestudy, alpha = alpha)
Fig4

# not excluding any methods
Fig4All.rowOrder <- levels(plotMethodRanks(objects, colLabels = casestudy, alpha = alpha, 
                               tableOnly = TRUE, excludeMethods = NULL)$method)
Fig4All <- plotMethodRanks(objects, colLabels = casestudy, alpha = alpha,
                        excludeMethods = NULL)
Fig4All

```

Extract a table of the values in Figure 4.

```{r}
# Supplementary table S3 
library(xtable)
tabS3 <- plotMethodRanks(objects, colLabels = casestudy, alpha = alpha,
                        tableOnly = TRUE)
tabS3 <- tabS3 %>% 
  mutate(mean_prop = ifelse(is.na(mean_prop), "-",
                            paste0(round(mean_prop,2), " (", round(min_prop,2), 
                            "-", round(max_prop, 2), ")"))) %>%
  select(casestudy, method, mean_prop) %>%
  spread(casestudy, mean_prop)

xtable(tabS3)
```

Create another panel with heatmap of yeast simulation results.

```{r}
objects <- list.files( path, recursive=TRUE, pattern="rds", full.names=TRUE )

# grab casestudy names
obj.names <- str_split(objects, pattern = "/")
casestudy <- unlist(lapply(obj.names, function(x) x[3] ))
dataset <- unlist(lapply(obj.names, function(x) x[4] ))

# non-null
wcs <- which(grepl("RNAseq", casestudy) & 
            !grepl(c("brain|mir|null|polyester"), dataset) &
            !grepl("scRNAseq", casestudy))
objs <- objects[wcs]
labs <- gsub(".rds", "", 
             unlist(lapply(str_split(dataset[wcs], pattern = "-results-"), 
                      function(x) x[2])))

pfdr <- plotMethodRanks(objs, 
                colLabels = c("sim", "sim"), 
                alpha = alpha, xlab = "Comparison",
                colorLow = "yellow", colorHigh = "navy",
                fill = "FDR",
                rowOrder = Fig4.rowOrder) 

ptpr <- plotMethodRanks(objs, 
                colLabels = c("sim", "sim"), 
                alpha = alpha, xlab = "Comparison",
                fill = "TPR",
                rowOrder = Fig4.rowOrder)  

plot_grid(Fig4, pfdr + ylab("") + xlab(""), ptpr + ylab("") + xlab(""), 
          ncol=3, rel_widths = c(1,0.3,0.3))
ggsave(file.path(outdir, "Figure4.pdf"), width=12, height=5)


```

# Figure 5

This is a multi-panel Figure displaying examples of covariate line plots in the
case studies. We'll create a 4-panel figure with the following case studies:
RNAseq, scRNAseq, GSEA, GWAS.

```{r, Figure 5}

objects <- list.files( path, recursive=TRUE, pattern="rds", full.names=TRUE )
resfile <- objects[grepl("RNAseq", objects) & grepl("brain", objects)] 
res <- readRDS(file=resfile)
assayNames(res) <- "qvalue"
res <- addDefaultMetrics(res)
pA <- covariateLinePlot(res, alpha=alpha, covname="ind_covariate", trans="log1p",
                        nbins=25) +
  ggtitle("RNA-seq case study: Brain") +
  xlab("Overall mean expression percentile") 

leg <-  get_legend(pA)
pA <- pA + theme(legend.position="none")


resfile <- objects[grepl("RNAseq", objects) & grepl("human", objects) &
                   grepl("mast", objects) & grepl("det", objects)] 
res <- readRDS(file=resfile)
assayNames(res) <- "qvalue"
res <- addDefaultMetrics(res)
pB <- covariateLinePlot(res, alpha=alpha, covname="detection", trans="log1p",
                        nbins=25) +
  ggtitle("scRNA-seq case study: Human, MAST") +
  xlab("Detection rate percentile") + 
  theme(legend.position="none")


resfile <- objects[grepl("GSEA", objects) & grepl("mouse", objects)] 
res <- readRDS(file=resfile)
assayNames(res) <- "qvalue"
res <- addDefaultMetrics(res)
pC <- covariateLinePlot(res, alpha=alpha, covname="ind_covariate", trans="log1p",
                        nbins=25) +
  ggtitle("GSEA case study: Mouse") +
  xlab("Gene Set size percentile") + 
  theme(legend.position="none")
 

resfile <- objects[grepl("GWAS", objects) & grepl("maf", objects)] 
res <- readRDS(file=resfile)
assayNames(res) <- "qvalue"
res <- addDefaultMetrics(res)
pD <- covariateLinePlot(res, alpha=alpha, covname="ind_covar_AF", trans="log1p",
                        nbins=25) +
  ggtitle("GWAS case study")+
  xlab("Minor Allele Frequency (MAF) percentile") +
  theme(legend.position="none")

p5 <- plot_grid(pA, pB, pC, pD, ncol=2, labels = LETTERS[1:4])
p5 <- plot_grid(p5, leg, ncol=2, rel_widths = c(1,0.2))
ggsave(file.path(outdir, "Figure5.pdf"), width=9, height=7)

```

# Figure 6

This is a multi-panel Figure displaying examples of covariate vs p-value scatterplots
and/or histograms in the case studies. 
It will be used to discuss how we evaluated the use of the 
covariates as independent and informative in the case studies.

```{r, Figure 6}
# TO DO
```

# Supplementary Figures

## Case-study specific plot analagous to Figure 2 

Figure 2 panels C-E for a case study. For now picking GWAS.

```{r Figure2.5}
objects <- list.files( path, recursive=TRUE, pattern="rds", full.names=TRUE )
resfile <- objects[grepl("GWAS", objects) & grepl("maf", objects)] 
res <- readRDS(file=resfile)
assayNames(res) <- "qvalue"
res <- addDefaultMetrics(res)

# Figure 2C: Total number of discoveries varied across method
p3 <- rejections_scatter(res, supplementary = FALSE) +
      theme(legend.position="none")+ 
  ggtitle("Number of rejections by alpha cutoff") + 
  xlab("alpha cutoff") +
  theme(axis.title = element_text(face="bold", size = 10),
        plot.title = element_text(face="bold", size = 14)) 

# Figure 2D: Some methods are tailored to detecting smaller effect sizes
p4 <- covariateLinePlot(res, alpha=alpha, covname="effect_size", trans="log1p",
                        transx = "exp", nbins=25)
leg <- get_legend(p4)
p4 <- p4 + theme(legend.position="none") + 
  ggtitle("Mean % significant by effect size %ile") + 
  theme(axis.title = element_text(face="bold", size = 10),
        plot.title = element_text(face="bold", size = 14)) +
  xlab("Effect size percentile")
  
# Figure 2E - upsetr plot - save separately
pdf(file.path(outdir, "FigureS0C.pdf"), width = 10, height = 4, onefile=FALSE)
plotFDRMethodsOverlap(res, 
                      alpha=alpha, nsets=ncol(res),
                      order.by="freq", decreasing=TRUE,
                      supplementary=FALSE, nintersects = 18) 
grid.text("Overlap for GWAS Case study, MAF covariate", x = 0.6, y = 0.97, 
          gp = gpar(fontsize = 16, fontface = "bold"))
grid.text("C", x = 0.02, y = 0.97, 
          gp = gpar(fontsize = 24, fontface = "bold")) 
dev.off()

# Figure 2 (ALL)
Fig2 <- plot_grid(p3, p4, ncol = 2, 
          labels = LETTERS[1:2], label_size = 20)
Fig2 <- plot_grid(Fig2, leg, ncol = 2, rel_widths = c(1, 0.2))
Fig2
ggsave(file.path(outdir, "FigureS0A-B.pdf"), width=10, height=4)

```

## Within case-study heatmaps of method rankings 

Here we generate heatmaps for each case study, where each column represents a different
dataset. Here we pick one representative covariate and method (if applicable) 
for each case study. See the individual Rmds for more detailed plots comparing, e.g.
different covariates on the same dataset.

```{r}
objects <- list.files( path, recursive=TRUE, pattern="rds", full.names=TRUE )

# grab casestudy names
obj.names <- str_split(objects, pattern = "/")
casestudy <- unlist(lapply(obj.names, function(x) x[3] ))
dataset <- unlist(lapply(obj.names, function(x) x[4] ))
```

### GWAS

```{r}
# by covariate
wcs <- which(grepl("GWAS", casestudy))
objs <- objects[wcs]
labs <- unlist(lapply(str_split(dataset[wcs], pattern = "-"), 
                      function(x) x[2]))
plotMethodRanks(objs, colLabels = labs, alpha = alpha, xlab = "Covariate",
                excludeMethods = NULL, Nlabel = FALSE) + 
  ggtitle("GWAS")
ggsave(file.path(outdir, "FigureS1.pdf"), width=4, height=4)
```

### GSEA

```{r}
#by dataset
wcs <- which(grepl("GSEA", casestudy))
objs <- objects[wcs]
labs <- unlist(lapply(str_split(dataset[wcs], pattern = "-benchmark.rds"), 
                      function(x) x[1]))
plotMethodRanks(objs, colLabels = labs, alpha = alpha, xlab = "Dataset", Nlabel = FALSE) + 
  ggtitle("GSEA")
ggsave(file.path(outdir, "FigureS2.pdf"), width=4, height=4)
```

### ChIP-seq

```{r}
wcs <- which(grepl("ChIPseq", casestudy))
objs <- objects[wcs]
labs <- unlist(lapply(str_split(dataset[wcs], pattern = "-benchmark.rds"), 
                      function(x) x[1]))
plotMethodRanks(objs, colLabels = labs, alpha = alpha, xlab = "Dataset", Nlabel = FALSE) + 
  ggtitle("ChIP-Seq")
ggsave(file.path(outdir, "FigureS3.pdf"), width=5, height=4)
```

### RNA-seq
```{r}
# by dataset
wcs <- which(grepl("RNAseq", casestudy) & 
            !grepl(c("polyester|yeast"), dataset) &
            !grepl("scRNAseq", casestudy))
objs <- objects[wcs]
labs <- unlist(lapply(str_split(dataset[wcs], pattern = "-benchmark.rds"), 
                      function(x) x[1]))
plotMethodRanks(objs, colLabels = labs, alpha = alpha, xlab = "Dataset", 
                excludeMethods = NULL, Nlabel = FALSE) + 
  ggtitle("RNA-seq")
ggsave(file.path(outdir, "FigureS4.pdf"), width=4, height=4)
```

### scRNA-seq

```{r}
wcs <- which(grepl("scRNAseq", casestudy))
objs <- objects[wcs]
ds <- unlist(lapply(str_split(dataset[wcs], pattern = "-benchmark-"), 
                      function(x) x[1]))
m0 <- unlist(lapply(str_split(dataset[wcs], pattern = "-benchmark-"), 
                      function(x) x[2]))
meth <- unlist(lapply(str_split(m0, pattern = "-"), 
                      function(x) x[1]))
cv <- gsub(".rds", "", unlist(lapply(str_split(m0, pattern = "-"), 
                      function(x) x[2])))

# by dataset
pa <- plotMethodRanks(objs, colLabels = ds, alpha = alpha, xlab = "Dataset") + 
  ggtitle("scRNA-seq")

# by method
pb <- plotMethodRanks(objs, colLabels = meth, alpha = alpha, xlab = "Method") + 
  ggtitle("scRNA-seq")

# by covariate
pc <- plotMethodRanks(objs, colLabels = cv, alpha = alpha, xlab = "Covariate") + 
  ggtitle("scRNA-seq")

plot_grid(pa, pb, pc)
ggsave(file.path(outdir, "FigureS5.pdf"), width=8, height=5.5)
```

### Microbiome

```{r}
# by dataset, excluding otu when genus is available
# excluding log-ubiquity
# excluding enigma-so4 (no discoveries)
wcs <- which(grepl("microbiome", casestudy) & 
              !(grepl(c("goodrich|papa"), dataset) & 
              grepl(c("otu"), dataset)) &
              !grepl("log-ubiquity", dataset) &
              !grepl("so4", dataset) &
              !grepl("baxter", dataset) )
objs <- objects[wcs]
labs <- unlist(lapply(str_split(dataset[wcs], pattern = "-benchmark.rds"), 
                      function(x) x[1]))
plotMethodRanks(objs, colLabels = labs, alpha = alpha, xlab = "Dataset", Nlabel = FALSE) + 
  ggtitle("Microbiome")
ggsave(file.path(outdir, "FigureS6.pdf"), width=7.5, height=4)
```

### Yeast Simulation

```{r}
# non-null
wcs <- which(grepl("RNAseq", casestudy) & 
            !grepl(c("brain|mir|polyester|null"), dataset) &
            !grepl("scRNAseq", casestudy))
objs <- objects[wcs]
labs <- gsub(".rds", "", 
             unlist(lapply(str_split(dataset[wcs], pattern = "-results-"), 
                      function(x) x[2])))

plotMethodRanks(objs, 
                colLabels = labs, 
                alpha = alpha, xlab = "Comparison",
                excludeMethods = NULL) 

plotMethodRanks(objs, 
                colLabels = labs, 
                alpha = alpha, xlab = "Comparison",
                excludeMethods = NULL, 
                fill = "FDR") 

plotMethodRanks(objs, 
                colLabels = labs, 
                alpha = alpha, xlab = "Comparison",
                excludeMethods = NULL, 
                fill = "TPR") 

# null
wcs <- which(grepl("RNAseq", casestudy) & 
            !grepl(c("brain|mir|polyester|de"), dataset) &
            !grepl("scRNAseq", casestudy))
objs <- objects[wcs]
labs <- gsub(".rds", "", 
             unlist(lapply(str_split(dataset[wcs], pattern = "-results-"), 
                      function(x) x[2])))

plotMethodRanks(objs, 
                colLabels = labs, 
                alpha = alpha, xlab = "Comparison",
                excludeMethods = NULL) 

```

### Polyester Simulation

```{r}
wcs <- which(grepl("RNAseq", casestudy) & 
            !grepl(c("brain|mir|yeast|null"), dataset) &
            !grepl("scRNAseq", casestudy))
objs <- objects[wcs]
labs <- gsub(".rds", "", 
             unlist(lapply(str_split(dataset[wcs], pattern = "-results-"), 
                      function(x) x[2])))

plotMethodRanks(objs, 
                colLabels = labs, 
                alpha = alpha, xlab = "Comparison",
                excludeMethods = NULL)

plotMethodRanks(objs, 
                colLabels = labs, 
                alpha = alpha, xlab = "Comparison",
                excludeMethods = NULL, 
                fill = "FDR") 

plotMethodRanks(objs, 
                colLabels = labs, 
                alpha = alpha, xlab = "Comparison",
                excludeMethods = NULL, 
                fill = "TPR") 

# null
wcs <- which(grepl("RNAseq", casestudy) & 
            !grepl(c("brain|mir|yeast|de"), dataset) &
            !grepl("scRNAseq", casestudy))
objs <- objects[wcs]
labs <- gsub(".rds", "", 
             unlist(lapply(str_split(dataset[wcs], pattern = "-results-"), 
                      function(x) x[2])))

plotMethodRanks(objs, 
                colLabels = labs, 
                alpha = alpha, xlab = "Comparison",
                excludeMethods = NULL) 
```

# Session information

```{r}
sessionInfo()
```
