---
title: "Case Study: ChIP-seq Differential Peak Calling (DiffBind)"
author: "Patrick Kimes"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
   html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

In this case study, we perform differential peak calling on ChIP-seq data of the histone
H3K4Me3 for samples from two cell lines (K562 and Gm12878) using publicly available data
generated by the ENCODE Project. The same data set is used for all ChIP-seq differential
testing case studies. 

Here, we use a popular differential peak calling algorithm, _DiffBind_ (Stark and Brown, 2011).
Rather than using pre-defined regions (e.g. promoters) or scanning the entire genome
(see _csaw_ case study), the _DiffBind_ approach starts from peak calls obtained using a
separate peak calling algorithm, e.g. _MACS_. Differential peaks are called among the
combined set of significant peaks across samples using methods originally developed for
differential expression testing, namely _DESeq2_ or _edgeR_.

For this analysis, peak calls are obtained from the ENCODE Project pipeline, and
testing is performed using _DiffBind_ and _DESeq2_.

# Workspace Setup

```{r, wkspace-setup, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(SummarizedBenchmark)
library(BiocParallel)
library(DiffBind)

## load helper functions
for (f in list.files("../R", "\\.(r|R)$", full.names = TRUE)) {
    source(f)
}

## project data/results folders
datdir <- "data"
resdir <- "results"
dir.create(datdir, showWarnings = FALSE)
dir.create(resdir, showWarnings = FALSE)

## intermediary files we create below
count_file <- file.path(resdir, "h3k4me3-diffbind-counts.rds")
result_file <- file.path(resdir, "h3k4me3-diffbind-results.rds")
bench_file <- file.path(resdir, "h3k4me3-diffbind-benchmark.rds")

## set up parallel backend
cores <- as.numeric(Sys.getenv("SLURM_NTASKS"))
multicoreParam <- MulticoreParam(workers = cores)
```

# Data Preparation

We downloaded the peak calls directly from the UCSC ENCODE portal.

```{r}
broad_url <- "http://hgdownload.soe.ucsc.edu/goldenPath/hg19/encodeDCC/wgEncodeBroadHistone/"
broad_peaks <- c("wgEncodeBroadHistoneGm12878H3k4me3StdPkRep1.narrowPeak.gz",
                 "wgEncodeBroadHistoneGm12878H3k04me3StdPkRep2V2.narrowPeak.gz",
                 "wgEncodeBroadHistoneK562H3k4me3StdPkRep1.narrowPeak.gz",
                 "wgEncodeBroadHistoneK562H3k4me3StdPkRep2.narrowPeak.gz")

for (i_peak in broad_peaks) {
    if (!file.exists(file.path(datdir, i_peak))) {
        download.file(paste0(broad_url, i_peak),
                      destfile = file.path(datdir, i_peak))
    }
}

uw_url <- "http://hgdownload.soe.ucsc.edu/goldenPath/hg19/encodeDCC/wgEncodeUwHistone/"
uw_peaks <- c("wgEncodeUwHistoneGm12878H3k4me3StdPkRep1.narrowPeak.gz",
              "wgEncodeUwHistoneGm12878H3k4me3StdPkRep2.narrowPeak.gz",
              "wgEncodeUwHistoneK562H3k4me3StdPkRep1.narrowPeak.gz",
              "wgEncodeUwHistoneK562H3k4me3StdPkRep2.narrowPeak.gz")

for (i_peak in uw_peaks) {
    if (!file.exists(file.path(datdir, i_peak))) {
        download.file(paste0(uw_url, i_peak),
                      destfile = file.path(datdir, i_peak))
    }
}
```

We determine sample metadata from the file names.

```{r}
peakfiles <- file.path(datdir, c(broad_peaks, uw_peaks))
labs <- gsub("wgEncode(.*)Histone.*", "\\1", basename(peakfiles))
cells <- gsub("wgEncode.*Histone(.*)H3k.*", "\\1", basename(peakfiles))

meta <- data.frame(cellline = cells, lab = labs, file = peakfiles,
                   stringsAsFactors = FALSE)
```

## Read Counting 

We determine the combined set of peak regions and count reads for each file.

```{r}
if (file.exists(count_file)) {
    cnts <- readRDS(count_file)
} else {
    ## run diffbind
    ## saveRDS(cnts, file = count_file)
}
```

# Data Analysis

## Differential Testing

First, we use _DiffBind_ to test for differential binding.

```{r count, results='hide', message=FALSE, warning=FALSE}
if (file.exists(result_file)) {
    res <- readRDS(result_file)
} else {
    ## run diffbind
    ## saveRDS(res, file = result_file)
}
```

# Session Info

```{r}
sessionInfo()
```
