---
title: "Case Study: ChIP-seq Differential Peak Testing (de novo regions)"
author: "Patrick Kimes, Mingxiang Teng"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
   html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

In this case study, we perform differential peak calling on ChIP-seq data for histone H3K4Me3
for samples from two cell lines (K562 and Gm12878) using publicly available data generated
by the ENCODE Project. Peak calls were generated by the ENCODE Project pipeline.
Differential testing was performed using both _DiffBind_ (Stark and Brown, 2011) and
_csaw_ (Lun and Smyth, 2016).

An alternative analysis using the same ChIP-seq data, but using pre-defined regions rather than
peak calls to test for differential binding, is performed in the accompanying `ChIPseq-promotors.Rmd` case study.

# Workspace Setup

```{r, wkspace-setup, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(SummarizedBenchmark)
library(BiocParallel)
library(GenomicRanges)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(DESeq2)
library(Rsubread)

## load helper functions
for (f in list.files("../R", "\\.(r|R)$", full.names = TRUE)) {
    source(f)
}

## project data/results folders
datdir <- "data"
resdir <- "results"
dir.create(datdir, showWarnings = FALSE)
dir.create(resdir, showWarnings = FALSE)

## set up parallel backend
cores <- as.numeric(Sys.getenv("SLURM_NTASKS"))
multicoreParam <- MulticoreParam(workers = cores)
```

# Data Preparation

We download the peak calls from the ENCODE Project site.

```
"https://www.encodeproject.org/files/ENCFF392CDW/@@download/ENCFF392CDW.bed.gz"
"https://www.encodeproject.org/files/ENCFF621QMO/@@download/ENCFF621QMO.bed.gz"
"https://www.encodeproject.org/files/ENCFF500EUY/@@download/ENCFF500EUY.bed.gz"
"https://www.encodeproject.org/files/ENCFF779FUO/@@download/ENCFF779FUO.bed.gz"
```

# Data Analysis

## Differential Testing

First, we use _DiffBind_ to test for differential binding.

```{r count, results='hide', message=FALSE, warning=FALSE}
diffbind_res  <- file.path(resdir, "h3k4me3-peaks-diffbind.rda")
if (file.exists(diffbind_res)) {
    load(diffbind_res)
} else {
    ## run diffbind
    ## save(res, file = diffbind_res)
}
```

## Covariate Diagnostics

Here, we can see that the covariant variable is actually informative.

### Covariate One

## Multiple-Testing Correction

We use the common `BenchDesign` with the set of multiple testing correction
methods already included.

```{r, chipseq-benchdesign}
bd <- initializeBenchDesign()
```

Now, we're ready to construct the `SummarizedBenchmark` object, which will run
the functions specified in each method.

```{r, chipseq-sb, results="hide", message=FALSE}
bench_res  <- file.path(resdir, "h3k4me3-peaks-sb.rda")
if (file.exists(bench_res)) {
    load(bench_res)
} else {
    sb <- buildBench(bd, data = dat, ftCols = c("ind_covariate"),
                     parallel = TRUE, BPPARAM = multicoreParam)
    save(sb, file = bench_res)
}
```

## Benchmark Metrics

Next, we'll add the default performance metric for q-value assays. First, we have
to rename the assay to 'qvalue'.

```{r, chipseq-metrics}
assayNames(sb) <- "qvalue"
sb <- addDefaultMetrics(sb)
```

Now, we'll plot the results.

```{r, chipseq-plot, results="hide"}
rejections_scatter(sb, supplementary = FALSE)
rejection_scatter_bins(sb, covariate = "ind_covariate",
                       bins = 4, supplementary = FALSE)

plotFDRMethodsOverlap(sb,  alpha = 0.05, nsets = ncol(sb),
                      order.by = "freq", decreasing = TRUE,
                      supplementary = FALSE)

methods <- c("ashs", "lfdr", "ihw-a10", "bl-df03", "qvalue", "bh", "bonf")
plotCovariateBoxplots(sb, alpha = 0.1, nsets = 6,
                      methods = methods, trans = log2, maxNum = 5)
```

# Session Info

```{r}
sessionInfo()
```
