---
title: "Case Study: RNA-Seq Differential Analysis"
author: "Chinmay Shukla"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

**Add brief summary of analysis goals and data set.**

# Workspace Setup

```{r, workspace-setup, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(DESeq2)
library(SummarizedBenchmark)
library(BiocParallel)

## load helper functions
for (f in list.files("../R", "\\.(r|R)$", full.names = TRUE)) {
    source(f)
}

## project data/results folders
datdir <- "data"
resdir <- "results"
dir.create(datdir, showWarnings = FALSE)
dir.create(resdir, showWarnings = FALSE)

## set up parallel backend
cores <- as.numeric(Sys.getenv("SLURM_NTASKS"))
multicoreParam <- MulticoreParam(workers = cores)
```

# Data Preparation

```{r, dsd-download}
dsd_data <- file.path(datdir, "dsdObjects.RData")
if (!file.exists(dsd_data)) {
    download.file("https://www.dropbox.com/s/8hf0ccl27ircodz/dsdObjects.RData?dl=1",
                  destfile = dsd_data)
}
load(dsd_data)
```

**Add details on content of data and subsetting.**

```{r}
## Filter to include samples from only 2 tissues
tissues <-  c('Brain - Nucleus accumbens (basal ganglia)',
              'Brain - Putamen (basal ganglia)')
filteredDsd1 <- dsd1[, colData(dsd1)$tissue %in% tissues]
filteredDsd1$tissue <- droplevels(filteredDsd1$tissue)
```

# Data Analysis

## Differential Testing

**Add details on how testing is performed.**

```{r}
res_rda <- file.path(resdir, "dsd1-results.rda")
if (!file.exists(res_rda)) {
    ## build DESeq object and run DESeq2
    dds <- DESeq(filteredDsd1, parallel = TRUE, BPPARAM = multicoreParam)
    res <- results(dds, independentFiltering = FALSE)

    save(dds, res, file = res_rda)
} else {
    load(res_rda)
}
```

**Add details on filtering.**

```{r}
## build input data.frame
geneExp <- data.frame(geneName = rownames(res),
                      pval = res$pvalue,
                      SE = res$lfcSE, 
                      ind_covariate = res$baseMean,
                      effect_size = res$log2FoldChange,
                      test_statistic = res$stat)
geneExp <- dplyr::as_tibble(geneExp)

## filter data
geneExp <- na.omit(geneExp)
geneExp <- dplyr::filter(geneExp, ind_covariate >= 1)
```

## Covariate Diagnostics

**Add description of covariates.**

### Mean Coverage

```{r}
strat_hist(geneExp, pvalue = "pval",
           covariate = "ind_covariate", maxy = 25)
```

```{r}
rank_scatter(geneExp, pvalue = "pval", covariate = "ind_covariate")
```

## Multiple-Testing Correction

We use the common `BenchDesign` with the set of multiple testing correction
methods already included.

```{r}
bd <- initializeBenchDesign()
sb <- buildBench(bd, data = geneExp)
```

## Benchmark Metrics

```{r}
assayNames(sb) <- "qvalue"
sb <- addDefaultMetrics(sb)
```

**Add description of results.**

```{r}
rejections_scatter(sb, supplementary = FALSE)
```

```{r}
plotFDRMethodsOverlap(sb, alpha = 0.05, nsets = ncol(sb),
                      order.by = "freq", decreasing = TRUE,
                      supplementary = FALSE)
```

# Session Info

```{r}
sessionInfo()
```
