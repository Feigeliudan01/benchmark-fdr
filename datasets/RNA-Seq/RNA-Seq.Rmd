---
title: "Case Study: RNA-Seq Differential Analysis"
author: "Chinmay Shukla, Patrick Kimes"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

**Add brief summary of analysis goals and details of data set.**
This data set includes 30 samples each from two regions of the human basal ganglia,
the nucleus accumbens and the putamen, obtained from the GTEx project.
Gene-level read counts were obtined by **fill**...

# Workspace Setup

```{r, workspace-setup, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(DESeq2)
library(SummarizedBenchmark)
library(BiocParallel)

## load helper functions
for (f in list.files("../R", "\\.(r|R)$", full.names = TRUE)) {
    source(f)
}

## project data/results folders
datdir <- "data"
resdir <- "results"
dir.create(datdir, showWarnings = FALSE)
dir.create(resdir, showWarnings = FALSE)

## intermediary files we create below
count_file <- file.path(datdir, "brain-counts.rds")
result_file <- file.path(resdir, "brain-results.rds")
bench_file <- file.path(resdir, "brain-benchmark.rds")

## set up parallel backend
cores <- as.numeric(Sys.getenv("SLURM_NTASKS"))
multicoreParam <- SerialParam()
```

# Data Preparation

The pre-computed set of samples can 

```{r, dsd-download}
if (!file.exists(count_file)) {
    download.file("", destfile = count_file)
}
dsd <- readRDS(count_file)
```

# Data Analysis

## Differential Testing

**Add details on how testing is performed.**

```{r}
if (!file.exists(result_file)) {
    ## build DESeq object and run DESeq2
    dds <- DESeq(dsd, parallel = TRUE, BPPARAM = multicoreParam)
    res <- results(dds, independentFiltering = FALSE)

    saveRDS(res, file = result_file)
} else {
    res <- readRDS(result_file)
}
```

**Add details on filtering.**

```{r}
## build input data.frame
geneExp <- data.frame(geneName = rownames(res),
                      pval = res$pvalue,
                      SE = res$lfcSE, 
                      ind_covariate = res$baseMean,
                      effect_size = res$log2FoldChange,
                      test_statistic = res$stat)
geneExp <- dplyr::as_tibble(geneExp)

## filter data
geneExp <- na.omit(geneExp)
geneExp <- dplyr::filter(geneExp, ind_covariate >= 1)
```

## Covariate Diagnostics

**Add description of covariates.**

### Mean Coverage

```{r, meancov-diag-scatter, fig.width=4.5, fig.height=3.5}
gp <- rank_scatter(geneExp, pvalue = "pval", covariate = "ind_covariate") +
    ggtitle("Mean coverage as independent covariate") +
    xlab("Mean Expression")
ggsave("temp.png", gp, width = 4.5, height = 3.5)
```

```{r, meancov-diag-hist, fig.width=10, fig.height=3.2}
strat_hist(geneExp, pvalue = "pval",
           covariate = "ind_covariate", maxy = 25)
```

## Multiple-Testing Correction

We use the common `BenchDesign` with the set of multiple testing correction
methods already included.

```{r}
if (!file.exists(bench_file)) {
    bd <- initializeBenchDesign()
    sb <- buildBench(bd, data = geneExp, ftCols = "ind_covariate")
    saveRDS(sb, file = bench_file)
} else {
    sb <- readRDS(bench_file)
}
```

## Benchmark Metrics

```{r}
assayNames(sb) <- "qvalue"
sb <- addDefaultMetrics(sb)
```

**Add description of results.**

```{r, rnaseq-scatter}
rejections_scatter(sb, supplementary = FALSE)
rejection_scatter_bins(sb, covariate = "ind_covariate",
                       bins = 4, supplementary = FALSE)
```

```{r, rnaseq-overlap}
plotFDRMethodsOverlap(sb, alpha = 0.05, nsets = ncol(sb),
                      order.by = "freq", decreasing = TRUE,
                      supplementary = FALSE)
```

```{r, rnaseq-boxplots}
## properties of method-exclusive discoveries
methods <- c("ashs", "lfdr", "ihw-a10", "bl-df03", "qvalue", "bh", "bonf")
plotCovariateBoxplots(sb, alpha = 0.1, nsets = 6,
                      methods = methods, trans = log2, maxNum = 5)
```

# Session Info

```{r}
sessionInfo()
```
