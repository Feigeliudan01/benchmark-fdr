---
title: "Benchmarking FDR Methods - Simulation Summarized ROC / UpsetR Plots"
author: "Rafalab Journal Club Members"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    highlight: tango
    number_sections: true
    code_folding: hide
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, fig.width = 12, fig.height = 10)
```

<!-- ######################################################################## -->
## Workspace Setup
<!-- ######################################################################## -->

```{r, load-libraries, message=FALSE}
library("SummarizedBenchmark")
library("tidyverse")
```

Let's just start with a single set of simulations. These simulations include 20,000 test statistics simulated from a normal distribution, with 90% simulated from a standard normal, and 10% simulated from a mean-shifted normal distribution. The different settings correspond to different mean shifts for the alternative tests. For each setting, the simulation results are summarized over 100 replications. 

```{r}
fl <- list.files("data-psim/M100/esize_fixed-bl-cubic-90-0.8",
                 pattern="M100\\.rds", full.names=TRUE)
```

<!-- ######################################################################## -->
## Average UpSet Plot Across Replicates
<!-- ######################################################################## -->

First, we consider generating UpSet plots for the average behavior over the 100 replications.

```{r}
## loop over simulation settings
for (f in fl) {

    ## read in list of SummarizedBenchmark objects (100 replications) 
    res <- readRDS(f)

    ## determine significant hits at 0.10 cutoff
    hits_tabs <- lapply(res, function(x) {
        as.tibble(cbind((assay(x, "qvalue") < 0.10) + 0,
                        truth = rowData(x)$qvalue)) %>%
            select(-starts_with("ihw-a0"),
                   -`bl-df02`,  -`bl-df04`,  -`bl-df05`) %>%
            rename(ihw = `ihw-a10`, bl = `bl-df03`,
                   scott_e = `scott-empirical`,
                   scott_t = `scott-theoretical`) %>%
            as.data.frame
    })
    
    ## count up frequencies
    freq_tabs <- lapply(hits_tabs,
                        function(x) {
                            UpSetR:::Counter(x, 11, 1, names(x), nintersections = 2^11,
                                             mbar_color = "gray23",
                                             order_mat = "degree", aggregate = "degree",
                                             cut = NULL, empty_intersects = TRUE,
                                             decrease = TRUE)
                        })
    
    ## merge all frequencies into single table
    freq_tab <- freq_tabs %>%
        mapply(function(itab, idx) { as.tibble(itab) %>%
                                         select(-x, -color) %>%
                                         rename(!!(paste0("freq.", idx)) := freq) },
               itab = ., idx = 1:length(freq_tabs),
               SIMPLIFY = FALSE) %>%
        reduce(left_join, by = c("unadjusted", "bonf", "bh", "qvalue", "ihw",
                                 "ashs", "bl", "lfdr", "scott_t", "scott_e", "truth"))

    ## summarize across 100 replications of each setting
    freq_tab <- freq_tab %>%
        gather(repl, cnt, starts_with("freq")) %>%
        group_by(unadjusted, bonf, bh, qvalue, ihw,
                 ashs, bl, lfdr, scott_t, scott_e, truth) %>%
        summarize(freq_mean = round(mean(cnt)),
                  freq_50p = round(median(cnt)),
                  freq_10p = round(quantile(cnt, .1)),
                  freq_90p = round(quantile(cnt, .9))) %>%
        ungroup %>%
        mutate(setname = paste(ifelse(unadjusted, "unadjusted", NA),
                               ifelse(bonf, "bonf", NA),
                               ifelse(bh, "bh", NA),
                               ifelse(qvalue, "qvalue", NA),
                               ifelse(ihw, "ihw", NA),
                               ifelse(ashs, "ashs", NA),
                               ifelse(bl, "bl", NA),
                               ifelse(lfdr, "lfdr", NA),
                               ifelse(scott_t, "scott_t", NA),
                               ifelse(scott_e, "scott_e", NA),
                               ifelse(scott_e, "truth", NA),
                               sep = '&'),
               setname = gsub("NA", "", setname) %>%
                   gsub("&{2,}", "&", .) %>%
                   gsub("^&", "", .) %>%
                   gsub("&$", "", .)) %>%
        select(setname, freq_mean,
               freq_50p, freq_10p, freq_90p)

    ## convert to vector to pass to UpSetR package
    freq_list <- freq_tab$freq_mean
    names(freq_list) <- freq_tab$setname


    ## make simple upset plot - save as png
    outdir <- gsub("data-", "plot-", dirname(f))
    dir.create(outdir, showWarnings = FALSE, recursive = TRUE)
    png(file.path(outdir, gsub("\\.rds", "-mean-upset.png", basename(f))),
        width = 10, height= 5, unit = "in", res = 300)

    upset(fromExpression(freq_list),
          nsets = 11,
          mb.ratio = c(0.55, 0.45),
          order.by = "freq",
          decreasing = TRUE,
          set.metadata = list(data = data.frame(sets = c("unadjusted", "bonf", "bh", "qvalue", "ihw",
                                                         "ashs", "bl", "lfdr", "scott_t", "scott_e", "truth"),
                                                isTruth = c(rep(FALSE, 10), TRUE)),
                              plots = list(
                                  list(type = "matrix_rows", 
                                       column = "isTruth",
                                       colors = c("TRUE" = "blue", "FALSE" = "gray"), 
                                       alpha = 0.2))))
    dev.off()
}
```


<!-- ######################################################################## -->
## Average ROC Plot Across Replicates
<!-- ######################################################################## -->

Next, we consider drawing average ROC curves for each setting...

